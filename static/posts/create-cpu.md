この記事は[Kosen14s Advent Calender 2017 3日目](https://adventar.org/calendars/2388)の記事です。

『わりとプログラミング言語は作れる』というタイトルで記事を書くつもりでいたけど、最近ずっとCPUを作っていて、ほとんど自作言語の進捗はないし、あんまりいま自作言語のことを考えたくなかったのでCPUの話に切り替えました。

ちょっとだけ自作言語の自慢をすると

```
main = fact 5
fact n = let
    iszero x = x == 0
    in if iszero n 
        then 1
        else n * fact (n-1)
```

みたいなコードから自作CPU向けのアセンブリが吐けます（たぶん）。

構文はMLみたいになっちゃいました、今は変数を実現するために参照型を追加したいのでいろいろ考えているのですが、ガベージコレクションが必要になって来てしまいました。めんどくさい…

## CPUを作る

割と簡単にCPUは作ることができます。あなたはCPUを作ると聞いてなにを思い浮かべましたか？汎用素子？まさか。

わたしは **ハードウェア記述言語** というものでCPUを作っています。以下はハードウェア記述言語のうちのひとつ、Verilogのコードです。

```verilog
module Sample(
    input wire ck,
    output bit signal
);
    initial signal = 0;
    
    always @(posedge ck) begin
        signal <= ~signal;
    end
endmodule
```
![sample\_RTL](/static/images/sample_rtl.png)

プログラミング言語みたいでしょう？これは一クロックごとに電気信号がOn/Offするとくに意味のない回路です。`module` が回路の塊をあらわしていて、 `input`, `output` がそれぞれ回路の入出力、 `always` はそのすぐ後に書かれている変数 `ck` (実際はフリップフロップ回路)が変化すると呼び出される関数のようなものです。イベント駆動的ですね。

このコードからは **論理合成** を行うことで右のような回路が出力されます。コードと回路が対応しているのがわかると思います。

論理合成はコンパイルのようなもので、論理記述言語で書いたコードから論理回路を生成することをさします。わたしは `quartus primel` と言うソフトウェアを使ってこれを行っています、余談なのですが、論理合成は滅茶滅茶時間がかかる。わたしの師匠は書いたコードの論理合成があまりに終わらないために書き直しをしていました。つらい。

System VerilogはほとんどC言語と同じ要領で扱えるので、プログラマーのわたしでも簡単に回路を設計することができます。といってもプログラムがそのまま回路になるので、意識して書かないとすぐ効率の悪い回路が生成されてしまうのですが…

プログラムを書くノリで書いてはいけない回路に以下のようなものがあります。

```
if (any_signal_a) begin
    if (any_signal_b) begin
        // code
    end
    if (any_signal_c) begin
        // code
    end
end
```

このコードを回路にしてしまうと、内側のif文は外側のif文を実行してからしか実行できないため、回路としては効率のわるいものが生成されてしまいます。以下のようなコードにすることでこの問題はかいけつできます。

```
if (any_signal_a && any_signal_b) begin
    // code
end
if (any_signal_a && any_signal_c) begin
        // code
end
```

このコードでは、それぞれのif文を並列で実行できる(上下で依存がなければですが)ので効率がよくなります。

ようするに、効率のよい回路を作るためには **クソコードを書かなければいけない** 

## 回路をシュミレーションする

System Verilogは論理回路を生成するためのものなのですが、書いたコードをそのまま実行することもできます。CPUの九割ぐらいはこのシュミレータの上で設計しています。

わたしは先輩からおすすめされた `Model Sim` というシュミレータを利用しています。実行環境を整えるのはクソ難しい(ついぞわたしはArch Linuxの上では動かすことができなかった)ので、Docker上のUbuntuで動かしています。Docker Fileは[わたしの師匠が公開しているもの](https://github.com/xztaityozx/modelsimDockerfile)を使うといいでしょう。

## 回路を実際に動かす

Verilogを書いて回路図のようなものができるのはよく分かったけど、これをどうやって回路にするのか想像もつかない？実はほとんどマイコンでプログラミングする要領で電子回路を生成することができます。違うのはマイコンの代わりにFPGAを利用する点と、FPGAが信じられないぐらいクソ高い点でしょうか？

> FPGA（英: field-programmable gate array）は、製造後に購入者や設計者が構成を設定できる集積回路である。
> https://ja.wikipedia.org/wiki/FPGA

FPGAは上記の引用のとおり、わたしたち開発者が必要に応じて書き換えられる便利な”回路の素”です。開発のために、作り直すたびに何億とかかるらしいASICとかつかってられないですからね。

それでどうやってFPGAに回路のデータを書き込むかって？よくわかりません、quartusに付属しているprogrammerがかってにやってくれます。

以下はバグらせて動かないので実機でデバッグしている様子です。

<iframe class="card" width="560" height="315" src="https://www.youtube.com/embed/CfU2q0g7-5Q" frameborder="0" allowfullscreen></iframe>

## 開発の流れ

まとめです

- このハードウェア記述言語で設計する
- シュミレーターの上でデバッグを行う
- 論理合成する
- FPGAに書き込む

の一連の流れでわたしはCPUを作っています。とりあえず `model sim`, `quartus prime`, `neovim` があればCPUはできます。

## 完成したCPU

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">三ヶ月ぐらい作ってた自作CPU, FPGA上で動きました。動画はとりあえずループで無限にカウンタを回してます、もっと早く処理できるけど見えなくなるのでここまで <a href="https://t.co/y3CGiXjmTp">pic.twitter.com/y3CGiXjmTp</a></p>&mdash; いらいざ (@Eliza_0x) <a href="https://twitter.com/Eliza_0x/status/934026752573112321?ref_src=twsrc%5Etfw">2017年11月24日</a></blockquote>

これは4ステージのパイプラインCPUです。作っていて設計があまりに教科書どうりになったのでちょっと笑ってしまった。今は8ステージ二並列のスーパーパイプライン、スーパースカラCPUを作っているところです。Out of Orderを実装したい。でもめんどくさい。たぶんVLIWになる。

目標は春に弊学で行われるCPU設計プロジェクトで優勝することです。出場する先輩達を泣かせます、任せてください。

## どうやって勉強したの？

白状します、勉強していません。直感で作っています。

> ぜんぜんわからない、俺達は雰囲気でCPUを作っている。

## CPUをつくっていて辛いところ

ネット上にはぜんぜん情報が存在していないし、シュミレータの上で動くのに回路に焼いたら動かないし、論理合成できないし、論理回路なので基本的に非同期だし、System Verilogの構文はつらいし、バグったら本当に原因がわからないし、設計は難しいし、僕は死ぬ。

あとこれは私が遭遇した現象ではないけど、作った回路があまりに大きくなってしまったため電気信号が到着するタイミングがズレてしまってバグってしまっていた。光が遅すぎる。

## おわりに

> にんげんはねぇ  
> Verilogを書くために  
> この世に生まれてきたのではないんだよ  
> にんげんがさき　Verilogがあと  

来週は簡単な進捗報告の記事をかきます。

私は本日OIT Advent Calender 2017で『[ブログを書くためにブログを作った](/#/posts/create-blog-vuejs.html)』もかいているので、もしよかったらそっちも読んでくれるとうれしいです。

明日の記事はちげくんの[電気科PV編集ファイル解説(1)]()です。楽しみですね。

